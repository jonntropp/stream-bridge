<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Bridge</title>
    <style>
        /* STILI BASE */
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; text-align: center; padding: 20px; box-sizing: border-box; }
        
        .container { max-width: 450px; width: 100%; }
        h2 { color: #fff; margin-bottom: 15px; font-weight: 600; }
        p { color: #b0b0b0; line-height: 1.6; margin-bottom: 25px; font-size: 15px; }
        
        /* CARD */
        .card { background: #1e1e1e; padding: 40px 30px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: none; }
        
        /* BOTTONI */
        .btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px 0; margin-top: 15px; text-decoration: none; border-radius: 12px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.1s, opacity 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn:hover { opacity: 0.9; }

        .btn-aloha { background: linear-gradient(135deg, #2d9cdb, #1e88e5); color: white; }
        .btn-store { background: #4caf50; color: white; } 
        .btn-chrome { background: #4285f4; color: white; } 
        
        .link-secondary { display: inline-block; margin-top: 25px; color: #666; font-size: 13px; text-decoration: none; border-bottom: 1px solid transparent; }
        .link-secondary:hover { color: #999; border-bottom-color: #999; }

        /* Loader */
        .loader { border: 3px solid #333; border-top: 3px solid #777; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 30px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TRAPPOLA CSS (Backup) */
        .adsbox { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loaderView">
            <div class="loader"></div>
            <p>Ottimizzazione player...</p>
        </div>

        <div id="pcView" class="card">
            <h2 style="color: #ffca28;">üí° Consiglio per la visione</h2>
            <p id="pcText">Il video contiene molte pubblicit√† fastidiose.</p>
            
            <a href="#" id="btnInstallExtension" target="_blank" class="btn btn-store">üõ°Ô∏è Installa uBlock Lite</a>
            
            <a href="https://www.google.com/chrome/" target="_blank" id="btnGetChrome" class="btn btn-chrome" style="display:none;">üåç Scarica Google Chrome</a>

            <a href="#" id="pcLinkContinue" class="link-secondary">No grazie, continua con le pubblicit√† &rarr;</a>
        </div>

        <div id="mobileView" class="card">
            <div class="loader"></div>
            <h2>Apertura App...</h2>
            <p>Stiamo avviando <b>Aloha Browser</b> per bloccare le pubblicit√†.</p>
            <a href="#" id="btnManualAloha" class="btn btn-aloha">üöÄ Clicca qui se non si apre</a>
        </div>

    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(params.get('url'));
        const cleanUrl = videoUrl ? videoUrl.replace(/^https?:\/\//, '') : '';

        // Imposta link "Continua comunque"
        if(videoUrl) document.getElementById('pcLinkContinue').href = videoUrl;

        // --- LINKS STORE AGGIORNATI ---
        // Ho inserito il link specifico che mi hai chiesto per Chrome
        const LINKS = {
            chrome: "https://chromewebstore.google.com/detail/ublock-origin-lite/ddkjiahejlhfcafbddmgiahcphecmpfh",
            edge: "https://microsoftedge.microsoft.com/addons/detail/ublock-origin-lite/fkfhgkbmjkgjlipdkhlmhgdjcofaaecp",
            firefox: "https://addons.mozilla.org/it/firefox/addon/ublock-origin/", 
            chromeDownload: "https://www.google.com/chrome/"
        };

        const MOBILE_STORES = {
            android: "https://play.google.com/store/apps/details?id=com.alohamobile.browser",
            ios: "https://apps.apple.com/it/app/aloha-browser-private-vpn/id1105317682"
        };

        // --- 1. RILEVAMENTO BROWSER PC ---
        function getBrowserType() {
            const ua = navigator.userAgent;
            if (ua.indexOf("Firefox") > -1) return "firefox";
            if (ua.indexOf("Edg") > -1) return "edge"; 
            if (ua.indexOf("Chrome") > -1) return "chrome";
            return "unknown";
        }

        function getOS() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) return "Android";
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return "iOS";
            return "Desktop";
        }

        // --- 2. RILEVAMENTO ADBLOCK (NETWORK + CSS) ---
        async function detectAdBlock() {
            let adBlockDetected = false;

            // METODO A: Network Check (Pi√π affidabile per uBlock Lite)
            // Proviamo a chiamare uno script di Google Ads.
            // Se la fetch fallisce (catch), √® probabile che un AdBlocker abbia bloccato la richiesta.
            try {
                const request = new Request("https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js", {
                    method: 'HEAD', 
                    mode: 'no-cors' // Importante per evitare errori CORS reali
                });
                
                await fetch(request).then(() => {
                    // Se entra qui, la richiesta √® partita. Niente AdBlock di rete.
                    console.log("Ads allowed");
                }).catch(() => {
                    // Se entra qui, la richiesta √® stata bloccata dal client (AdBlock).
                    console.log("Ads blocked by network filter");
                    adBlockDetected = true;
                });
            } catch (e) {
                adBlockDetected = true;
            }

            // METODO B: CSS Check (Backup)
            if (!adBlockDetected) {
                const bait = document.createElement('div');
                bait.className = 'adsbox pub_300x250 ad-placement';
                bait.style.position = 'absolute';
                bait.style.top = '-1000px';
                bait.innerHTML = '&nbsp;';
                document.body.appendChild(bait);
                
                // Ritardo minimo per permettere l'applicazione dello stile
                await new Promise(r => setTimeout(r, 100));

                if (bait.offsetHeight === 0 || window.getComputedStyle(bait).display === 'none') {
                    console.log("Ads blocked by cosmetic filter");
                    adBlockDetected = true;
                }
                document.body.removeChild(bait);
            }

            return adBlockDetected;
        }

        // --- 3. LOGICA PRINCIPALE ---
        const os = getOS();

        if (os === "Desktop") {
            // ESEGUI TEST
            detectAdBlock().then((hasAdBlock) => {
                document.getElementById('loaderView').style.display = 'none';

                if (hasAdBlock) {
                    // PROTETTO -> Vai al video
                    window.location.href = videoUrl;
                } else {
                    // NON PROTETTO -> Mostra Consiglio
                    const browser = getBrowserType();
                    const btn = document.getElementById('btnInstallExtension');
                    const pcText = document.getElementById('pcText');
                    const view = document.getElementById('pcView');

                    view.style.display = 'block';

                    if (browser === 'chrome') {
                        pcText.innerHTML += "<br>Per <b>Google Chrome</b>, ti consigliamo questa estensione gratuita:";
                        btn.href = LINKS.chrome;
                        btn.innerText = "üõ°Ô∏è Aggiungi uBlock Lite";
                    } else if (browser === 'edge') {
                        pcText.innerHTML += "<br>Per <b>Edge</b>, ti consigliamo questa estensione gratuita:";
                        btn.href = LINKS.edge;
                        btn.innerText = "üõ°Ô∏è Aggiungi uBlock Lite";
                    } else if (browser === 'firefox') {
                        pcText.innerHTML += "<br>Per <b>Firefox</b>, ti consigliamo questa estensione gratuita:";
                        btn.href = LINKS.firefox;
                        btn.innerText = "üõ°Ô∏è Aggiungi uBlock Origin";
                    } else {
                        // Browser non supportato
                        pcText.innerHTML += "<br>Il tuo browser non supporta la protezione ottimale.<br>Ti consigliamo <b>Google Chrome</b>.";
                        btn.style.display = 'none';
                        const btnChrome = document.getElementById('btnGetChrome');
                        btnChrome.style.display = 'flex';
                    }
                }
            });
        } 
        
        // --- MOBILE (ALOHA FORCE) ---
        else {
            document.getElementById('loaderView').style.display = 'none';
            document.getElementById('mobileView').style.display = 'block';
            const btnManual = document.getElementById('btnManualAloha');

            if (os === "Android") {
                const fallback = encodeURIComponent(MOBILE_STORES.android);
                const intent = "intent://" + cleanUrl + "#Intent;scheme=https;package=com.alohamobile.browser;action=android.intent.action.VIEW;category=android.intent.category.BROWSABLE;S.browser_fallback_url=" + fallback + ";end";
                
                btnManual.href = intent;
                setTimeout(() => { window.location.href = intent; }, 500);
            } 
            else {
                // iOS
                const iosScheme = "alohabrowser://" + cleanUrl;
                btnManual.href = iosScheme;
                btnManual.innerText = "Apri in Aloha";
                window.location.href = iosScheme;
                
                setTimeout(() => {
                    btnManual.innerText = "‚¨áÔ∏è Installa Aloha (Gratis)";
                    btnManual.href = MOBILE_STORES.ios;
                    btnManual.classList.remove('btn-aloha');
                    btnManual.classList.add('btn-store');
                }, 2500);
            }
        }
    </script>
</body>
</html>
