<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Bridge</title>
    <style>
        /* STILI BASE */
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; text-align: center; padding: 20px; box-sizing: border-box; }
        
        .container { max-width: 480px; width: 100%; }
        h2 { color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 22px; }
        p { color: #b0b0b0; line-height: 1.5; margin-bottom: 20px; font-size: 15px; }
        
        /* CARD */
        .card { background: #1e1e1e; padding: 30px 25px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: none; }
        
        /* BOTTONI */
        .btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px 0; margin-top: 15px; text-decoration: none; border-radius: 12px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }

        .btn-aloha { background: linear-gradient(135deg, #2d9cdb, #1e88e5); color: white; }
        .btn-store { background: #2e7d32; color: white; } /* Verde Scuro */
        .btn-chrome { background: #1a73e8; color: white; } 
        
        .timer-bar { width: 100%; height: 4px; background: #333; margin-top: 25px; border-radius: 2px; overflow: hidden; position: relative; }
        .timer-fill { height: 100%; background: #2d9cdb; width: 100%; transition: width 1s linear; }

        .skip-link { display: inline-block; margin-top: 15px; color: #777; font-size: 13px; text-decoration: underline; cursor: pointer; }

        /* Loader */
        .loader { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 30px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loaderView">
            <div class="loader"></div>
            <p>Preparazione visione...</p>
        </div>

        <div id="pcView" class="card">
            <h2 style="color: #ffca28;">‚ö†Ô∏è Pubblicit√† Invadenti</h2>
            <p id="pcText">Questo video aprir√† molte finestre popup.<br>Consigliamo vivamente di proteggerti.</p>
            
            <a href="#" id="btnInstallExtension" target="_blank" class="btn btn-store">üõ°Ô∏è Installa uBlock Lite</a>
            
            <a href="https://www.google.com/chrome/" target="_blank" id="btnGetChrome" class="btn btn-chrome" style="display:none;">üåç Scarica Chrome</a>

            <div style="margin-top: 30px; text-align: left;">
                <span style="font-size: 12px; color: #888;">Avvio automatico in <b id="countdown">5</b>s...</span>
                <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
            </div>

            <a href="#" id="pcLinkSkip" class="skip-link">Salta attesa e vai al video &rarr;</a>
        </div>

        <div id="mobileView" class="card">
            <div class="loader"></div>
            <h2>Apertura App...</h2>
            <p>Avvio di <b>Aloha Browser</b> in corso.</p>
            <a href="#" id="btnManualAloha" class="btn btn-aloha">üöÄ Clicca qui se non si apre</a>
        </div>

    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(params.get('url'));
        const cleanUrl = videoUrl ? videoUrl.replace(/^https?:\/\//, '') : '';

        // Imposta link Skip
        if(videoUrl) document.getElementById('pcLinkSkip').href = videoUrl;

        // LINKS STORE (uBlock Lite MV3 / Aloha)
        const LINKS = {
            chrome: "https://chromewebstore.google.com/detail/ublock-origin-lite/ddkjiahejlhfcafbddmgiahcphecmpfh",
            edge: "https://microsoftedge.microsoft.com/addons/detail/ublock-origin-lite/fkfhgkbmjkgjlipdkhlmhgdjcofaaecp",
            firefox: "https://addons.mozilla.org/it/firefox/addon/ublock-origin/", 
            chromeDownload: "https://www.google.com/chrome/"
        };

        const MOBILE_STORES = {
            android: "https://play.google.com/store/apps/details?id=com.alohamobile.browser",
            ios: "https://apps.apple.com/it/app/aloha-browser-private-vpn/id1105317682"
        };

        // --- UTILIT√Ä ---
        function getBrowserType() {
            const ua = navigator.userAgent;
            if (ua.indexOf("Firefox") > -1) return "firefox";
            if (ua.indexOf("Edg") > -1) return "edge"; 
            if (ua.indexOf("Chrome") > -1) return "chrome";
            return "unknown";
        }

        function getOS() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(ua)) return "Android";
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return "iOS";
            return "Desktop";
        }

        // --- RILEVAMENTO ADBLOCK (SCRIPT INJECTION) ---
        // Questo metodo prova a caricare uno script pubblicitario reale.
        // Se lo script non carica (onerror), AdBlock √® attivo.
        // Se lo script carica (onload), AdBlock non c'√®.
        function detectAdBlock(callback) {
            const script = document.createElement('script');
            script.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
            script.type = "text/javascript";
            script.async = true;

            // Se viene bloccato, scatta onerror -> AdBlock Presente
            script.onerror = function() {
                document.body.removeChild(script);
                callback(true); 
            };

            // Se viene caricato, scatta onload -> AdBlock Assente
            script.onload = function() {
                document.body.removeChild(script);
                callback(false);
            };

            // Se per qualche motivo il browser va in timeout (connessione lenta), assumiamo false
            setTimeout(() => {
                if(document.body.contains(script)) {
                    document.body.removeChild(script);
                    // Non richiamiamo callback se √® gi√† stato chiamato, ma per sicurezza consideriamo false
                    // (meglio mostrare il consiglio che mandare su sito virus)
                }
            }, 3000);

            document.body.appendChild(script);
        }

        // --- LOGICA TIMER ---
        function startCountdown() {
            let seconds = 5;
            const countElem = document.getElementById('countdown');
            const fillElem = document.getElementById('timerFill');
            
            const interval = setInterval(() => {
                seconds--;
                countElem.innerText = seconds;
                
                // Aggiorna barra
                const percentage = (seconds / 5) * 100;
                fillElem.style.width = percentage + "%";

                if (seconds <= 0) {
                    clearInterval(interval);
                    window.location.href = videoUrl; // Redirect automatico
                }
            }, 1000);
        }

        // --- ESECUZIONE ---
        const os = getOS();

        if (os === "Desktop") {
            detectAdBlock((hasAdBlock) => {
                document.getElementById('loaderView').style.display = 'none';

                if (hasAdBlock) {
                    // AD BLOCK RILEVATO -> Redirect immediato
                    window.location.href = videoUrl;
                } else {
                    // NO AD BLOCK (O Falso Negativo) -> Mostra UI con Timer
                    const browser = getBrowserType();
                    const btn = document.getElementById('btnInstallExtension');
                    const pcText = document.getElementById('pcText');
                    
                    document.getElementById('pcView').style.display = 'block';
                    
                    // Configura il tasto in base al browser
                    if (browser === 'chrome') {
                        btn.href = LINKS.chrome;
                        btn.innerText = "üõ°Ô∏è Aggiungi a Chrome (Consigliato)";
                    } else if (browser === 'edge') {
                        btn.href = LINKS.edge;
                        btn.innerText = "üõ°Ô∏è Aggiungi a Edge";
                    } else if (browser === 'firefox') {
                        btn.href = LINKS.firefox;
                        btn.innerText = "üõ°Ô∏è Aggiungi a Firefox";
                    } else {
                        btn.style.display = 'none';
                        document.getElementById('btnGetChrome').style.display = 'flex';
                    }

                    // AVVIA IL CONTO ALLA ROVESCIA
                    startCountdown();
                }
            });
        } 
        
        // --- MOBILE ---
        else {
            document.getElementById('loaderView').style.display = 'none';
            document.getElementById('mobileView').style.display = 'block';
            const btnManual = document.getElementById('btnManualAloha');

            if (os === "Android") {
                const fallback = encodeURIComponent(MOBILE_STORES.android);
                const intent = "intent://" + cleanUrl + "#Intent;scheme=https;package=com.alohamobile.browser;action=android.intent.action.VIEW;category=android.intent.category.BROWSABLE;S.browser_fallback_url=" + fallback + ";end";
                btnManual.href = intent;
                setTimeout(() => { window.location.href = intent; }, 500);
            } else {
                const iosScheme = "alohabrowser://" + cleanUrl;
                btnManual.href = iosScheme;
                btnManual.innerText = "Apri in Aloha";
                window.location.href = iosScheme;
                setTimeout(() => {
                    btnManual.innerText = "‚¨áÔ∏è Installa Aloha (Gratis)";
                    btnManual.href = MOBILE_STORES.ios;
                    btnManual.classList.remove('btn-aloha');
                    btnManual.classList.add('btn-store');
                }, 2500);
            }
        }
    </script>
</body>
</html>
